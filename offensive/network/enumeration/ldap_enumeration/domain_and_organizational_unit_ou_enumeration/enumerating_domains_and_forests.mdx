---
title: Comprehensive Guide to Enumerating Domains and Forests
description: Learn essential techniques for enumerating domains and forests in Active
  Directory, including tools, scripting, and evasion strategies.
keywords:
- domain enumeration
- forest enumeration
- Active Directory
- LDAP queries
- DNS zone transfer
- smb enumeration
- PowerShell AD
- Bloodhound
- Kerberos
- network enumeration
---

## Enumerating Domains and Forests

### Domain Enumeration Techniques

**DNS Zone Transfers:** DNS zone transfer, also known as AXFR, is a type of DNS transaction that replicates DNS databases from a primary DNS server to a secondary server. When improperly configured, a DNS server may allow unauthorized requests, providing a full listing of domain names and IP addresses. To exploit this, an attacker can use tools like `dig` or `nslookup`. For example, to perform a zone transfer, one could use the command:

```bash
dig axfr @dns-server domainname.com
```

If successful, this command would yield a list of all DNS records for the domain, facilitating further enumeration.

**Domain Controller Discovery:** Identifying domain controllers within a network is crucial as they host Active Directory services. This can be achieved using service discovery tools like Nmap with the `-p` flag to scan for port 389 (LDAP) or port 445 (SMB) open on potential domain controllers:

```bash
nmap -p 389,445 target-network-range
```

Alternatively, querying for SRV records in DNS can reveal domain controllers:

```bash
nslookup -type=SRV _ldap._tcp.domainname.com
```

**LDAP Queries for Domains:** Custom LDAP queries can be constructed to extract valuable domain information, such as user lists, groups, and computer accounts. A simple LDAP search using `ldapsearch` might look like:

```bash
ldapsearch -x -h domain-controller -b "dc=domainname,dc=com" "(objectclass=*)"
```

This command returns all objects and their attributes from the specified domain.

**NetBIOS Name Service:** NetBIOS over TCP/IP allows devices to discover each other on a LAN. Tools like `nbtscan` can be used to enumerate NetBIOS name information:

```bash
nbtscan -r target-ip-range
```

This will list NetBIOS names, workgroups, and associated IP addresses, helping map the domain landscape.

**SMB Service Scans:** The SMB protocol can reveal significant information about domain resources. Utilizing tools like `smbclient` or `enum4linux` allows you to extract information such as share lists and user accounts:

```bash
enum4linux -a target-ip
```

### Forest Enumeration Techniques

**Cross-Domain Trust Exploration:** Forests often contain multiple domains with mutual trust relationships. Tools like `Bloodhound` help visualize these trusts and potential lateral movement routes through:

1. **Collecting domain trusts** using a PowerShell script or Bloodhound’s ingestor.
2. **Analyzing trust paths** to strategize attack vectors.

**Global Catalog Queries:** The Global Catalog is a directory database that contains information about every object in a forest. LDAP queries against the Global Catalog can enumerate resources across domains:

```bash
ldapsearch -x -h domain-controller:3268 -b "<forest-root-dn>" "(objectclass=*)"
```

This command returns cross-domain information essential for understanding the forest structure.

**AD Sites and Services Enumeration:** Active Directory sites manage replication and authentication across a network. To enumerate site-related information, inspect the `CN=Sites` partition using LDAP:

```bash
ldapsearch -x -h domain-controller -b "CN=Sites,CN=Configuration,DC=domainname,DC=com" "(objectclass=site)"
```

**Kerberos Authentication Mechanisms:** Kerberos tickets and tokens can be revealing about domain hierarchies. Tools such as `Rubeus` or `Mimikatz` might be used to extract Ticket Granting Tickets (TGTs) or analyze Kerberos authentication processes for enumeration purposes.
  
**Security Identifier (SID) Reference:** Security Identifiers (SIDs) often reveal user, domain, and group information. By translating SIDs, one can understand organizational structures within a forest. This can be accomplished using PowerShell scripts or tools like `whoami /ALL`.

### Tools and Scripts for Domain and Forest Enumeration

**Nmap LDAP Scripts:** Utilize Nmap’s built-in LDAP scripts such as `ldap-search` to interact with directory services:

```bash
nmap --script ldap-search -p 389,636 target-ip
```

This might quickly yield organizational units and user accounts.

**LDAP Admin Tools:** Tools such as `Apache Directory Studio` or `LDAP Admin` facilitate LDAP interactions, providing GUI-based query capabilities that simplify enumeration processes.

**PowerShell for AD Enumeration:** Custom scripts can streamline the retrieval of domain and forest information. For example:

```powershell
Get-ADForest
Get-ADDomain
```

These PowerShell commands provide detailed forest and domain information when executed within a directory-aware host.

**Bloodhound:** Bloodhound uses graph theory to identify and analyze Active Directory relationships. By populating it with data collected via `SharpHound`, it provides a visual mapping of domain trusts, users, and computers.

**Metasploit Auxiliary Modules:** Metasploit includes auxiliary modules for Active Directory enumeration. Commands in `msfconsole` like `use auxiliary/scanner/ldap/enum_ad` can be efficient for querying LDAP information.

### Crafting and Customizing Enumeration Techniques

**Custom LDAP Filters:** To retrieve specific directory information, advanced LDAP filters can be crafted. These filters refine searches and minimize data noise, enhancing precision:

```bash
ldapsearch -x -h domain-controller -b "dc=domainname,dc=com" "(&(objectClass=user)(mail=*))"
```

This example retrieves all users with an email attribute, useful for targeted enumeration.

**Automated Enumeration Scripts:** Automated scripts scripted in languages such as Python or PowerShell can execute sequence-based enumeration tasks, ensuring comprehensive data collection without manual intervention.

**Analyzing Enumeration Output:** Techniques for parsing outputs, such as using tools like `grep`, `awk`, or custom parsing scripts, are integral for distilling immense data into actionable intelligence.

### Mitigation and Evasion

**Log Evasion Techniques:** Evading logging requires tactics like modifying query syntax, throttling requests, or masking queries through various proxies to maintain a semblance of legitimacy.

**Bypassing Network Defenses:** Employing stealth techniques like encrypted channels (SSH tunneling, VPNs) or connection anonymizers (Tor) can thwart network egress controls during enumeration activities.

**Camouflaging LDAP Queries:** Queries can be tailored to match normal operational patterns, reducing the risk of detection by network anomaly monitoring systems. For instance, intermingling regular user queries with probing queries during off-hours can avoid triggering alerts.