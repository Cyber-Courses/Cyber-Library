---
title: Exploiting Microsoft Azure IMDS with SSRF Techniques
description: Learn how to exploit Azure Instance Metadata Service using SSRF for sensitive
  data extraction.
keywords:
- Azure
- SSRF
- IMDS
- metadata service
- managed identity
- cloud security
- networking
- vulnerability
---

# Microsoft Azure

## Context

The objective is to demonstrate how to exploit the Azure Instance Metadata Service (IMDS) using Server-Side Request Forgery (SSRF) techniques to extract sensitive credentials and information. The reader is assumed to have knowledge of HTTP headers, web form structures, cloud service models, and the specific techniques of SSRF and Cloud Metadata Services Exploitation.

## Theory

### Azure Instance Metadata Service (IMDS) Overview

The Azure Instance Metadata Service (IMDS) is a RESTful web service that resides at the endpoint `http://169.254.169.254/metadata/instance`. This service allows Azure Virtual Machines (VMs) to access metadata about themselves, such as configurations and network details. This service is crucial because it provides sensitive instance data, including tokens for managed identities, allowing workloads within Azure VMs to authenticate with Azure services.

### Accessing IMDS via SSRF

To exploit the IMDS via SSRF, an attacker forms crafted requests from a vulnerable web application that can perform outbound HTTP requests. Successful exploitation requires the application to allow such requests and possess an exploitable SSRF vulnerability.

### IMDS Request Structure and Security Controls

When querying IMDS, the request must include the 'Metadata: true' HTTP header. Without this header, the IMDS requests will be rejected. Many SSRF payloads encounter issues if custom headers are impossible to set. In such cases, attackers may need to leverage header injection techniques or use proxying mechanisms to overcome this limitation.

### Sensitive Data Exposed by IMDS

IMDS can reveal various types of sensitive data, such as instance metadata, network configurations, public IP addresses, and managed identity tokens. These managed identity tokens are particularly valuable as they can be used to access Azure resources with the same privileges assigned to the virtual machine, potentially leading to privilege escalation.

## Practice

### SSRF Exploitation of Azure IMDS for Metadata Retrieval

- **Craft an SSRF payload** targeting the Azure IMDS endpoint. The payload should query detailed instance metadata.
- Use the following endpoint in your payload:
```http
http://169.254.169.254/metadata/instance?api-version=2017-04-02
- **Include the required HTTP header**: Metadata: true. This is essential for a successful request.
- **Submit your payload** via the SSRF vector, which may be a vulnerable URL parameter, POST body, or even a header, depending on the application's SSRF vulnerability.

**Outcome:** Successfully executing these steps should result in access to Azure VM instance metadata, including network information and possible managed identity references.

### Extracting Managed Identity Access Tokens via SSRF

- **Target the IMDS identity endpoint** to request an OAuth2 token, which can be used to access Azure services.
- Use the following endpoint for token requests:
  ```http
  http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/
  ```
- **Include the header**: Metadata: true. This is mandatory for obtaining an OAuth2 token.
- **Submit the payload** via the SSRF vector and capture the response. The response will contain the access token.

**Outcome:** This technique results in the extraction of a managed identity OAuth2 access token, allowing authenticated access to various Azure resources.

### Enumerating Network Interfaces and Public IPs via IMDS

- **Use the endpoint** below to query for network interface details:
  ```http
  http://169.254.169.254/metadata/instance/network/interface?api-version=2017-08-01
  ```
- **Include the header**: Metadata: true in your SSRF request.
- **Submit the payload** through the SSRF vector and observe the response to analyze network configuration and discover public IPs.

**Outcome:** These actions lead to the discovery of virtual machine network interfaces and public IP addresses via IMDS, useful information for further network mapping or potential lateral movement.

## Tools

- **Burp Suite**
- **curl**
- **Postman**