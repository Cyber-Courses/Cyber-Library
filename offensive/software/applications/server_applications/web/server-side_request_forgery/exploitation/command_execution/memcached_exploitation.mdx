---
title: Comprehensive Guide to Memcached Exploitation
description: Explore techniques for exploiting Memcached vulnerabilities using SSRF
  and RCE methods.
keywords:
- Memcached
- exploitation
- SSRF
- remote code execution
- deserialization
- protocol weaknesses
- Gopherus
- phprce
- pymemcache
---

# Memcached Exploitation

## Context

The primary objective of this article is to demonstrate how attackers can exploit Memcached services using Server-Side Request Forgery (SSRF) techniques for remote command execution. This method leverages weaknesses in the Memcached protocol and exploits deserialization vulnerabilities in web applications using Memcached as a caching layer. The reader is expected to be familiar with the Memcached protocol, SSRF mechanisms, and possess a basic understanding of server-side request forgery and command execution techniques.

## Theory

### Memcached Protocol Weaknesses

Memcached is a popular in-memory key-value store utilized to improve the performance of dynamic web applications by alleviating database load. It communicates via a simple ASCII protocol over TCP or UDP, which lacks authentication and encryption, making it inherently insecure if exposed to untrusted networks. Any client with access to the Memcached port can issue commands, which presents significant security risks in exposed instances.

### SSRF as a Vector for Memcached Exploitation

Server-Side Request Forgery (SSRF) is an attack vector where an attacker manipulates a vulnerable server to send unauthorized requests to internal or external systems. In the context of Memcached exploitation, an attacker uses an SSRF vulnerability in a web application to relay crafted Memcached protocol payloads to target internal Memcached services. The gopher protocol plays a crucial role in this exploitation method because it allows the transmission of arbitrary TCP payloads, enabling complex attack scenarios such as this.

### Remote Code Execution via Deserialization

Certain web applications store serialized PHP or other object types within Memcached. If an application later deserializes this content without adequate verification or sanitization, it can lead to remote code execution (RCE). An attacker can craft and inject a malicious serialized payload through SSRF, which the application later processes, thereby executing arbitrary code.

### Tooling for Memcached Exploitation

Several tools facilitate the exploitation of Memcached vulnerabilities:
- **Gopherus**: Automates the crafting and encoding of gopher:// URLs for SSRF.
- **phprce**: Assists in generating PHP-specific serialized payloads for RCE.
- **pymemcache**: A Python library for interfacing with Memcached, useful for crafting custom payloads.

## Practice

### SSRF to Memcached for Remote Code Execution (PHP Deserialization)

This technique involves leveraging SSRF to execute arbitrary code by exploiting insecure PHP deserialization stored in Memcached.

- Identify an SSRF entry point within the application, particularly one that supports the gopher:// scheme or allows raw TCP payloads.
- Construct a PHP serialized object payload designed to trigger RCE:

    ```php
    set exploit 0 0 50\rO:8:"ExploitMe":1:{s:4:"data";s:13:"system('id');";}\r
    ```

    Adjust the class name and parameters as per the application's deserialization context.

- Encode the payload for gopher:// transfer, ensuring all special characters and line breaks are appropriately URL-encoded.

- Use a command with Gopherus to automate payload assembly and SSRF delivery:

    ```bash
    python3 gopherus.py --type memcached --payload 'set exploit 0 0 50\rO:8:\"ExploitMe\":1:{s:4:\"data\";s:13:\"system(\'id\');\";}' --ssrf-url 'http://target/ssrf?url='
    ```

- Trigger the application logic that deserializes the injected object by navigating to a specific endpoint or allowing natural application processes to occur.

Upon successful exploitation, remote code execution is achieved on the application server by executing the payload embedded within the serialized object.

### Manual Memcached Command Injection via SSRF

In this method, we craft Memcached protocol commands manually and deliver them over SSRF to exploit potential application vulnerabilities.

- Design raw Memcached protocol commands compatible for SSRF-based injection. The following demonstrates a basic command to verify write access:

    ```plaintext
    set testkey 0 0 4\rtest\r
    ```

- Encode special characters and line breaks for gopher:// scheme before incorporating them into the SSRF request.

- Observe the server or application for any changes in behavior or output as an indication of command injection efficacy.

By leveraging SSRF in this manner, attackers can execute arbitrary commands within Memcached, highlighting misconfiguration or security lapses in application setups.

## Tools

- **Gopherus**
- **phprce**
- **pymemcache**