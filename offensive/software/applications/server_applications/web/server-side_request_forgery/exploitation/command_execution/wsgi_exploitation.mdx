---
title: 'WSGI Exploitation: Remote Command Execution via SSRF'
description: Explore how to achieve remote command execution on WSGI servers by exploiting
  SSRF vulnerabilities.
keywords:
- WSGI exploitation
- uWSGI protocol
- SSRF
- remote command execution
- Python script
- uWSGI_FILE
- Gopher encoding
- security vulnerabilities
- web server exploitation
---

# WSGI Exploitation

## Context

The goal of this guide is to enable offensive security operators to achieve remote command execution on WSGI servers through Server-Side Request Forgery (SSRF), by exploiting the uWSGI protocol and WSGI file loading mechanisms. It is assumed that the reader has foundational knowledge of WSGI architecture and deployment models, HTTP protocol fundamentals, the mechanisms behind SSRF attack vectors, and general command execution exploitation techniques.

## Theory

### uWSGI Protocol and WSGI File Loading

uWSGI is a binary protocol employed for communication between web servers and Python-based WSGI applications. This protocol is crucial in facilitating an efficient interaction within these environments. A core principle of uWSGI servers is their configuration capability to load Python scripts from arbitrary file paths utilizing the `UWSGI_FILE` parameter.

In terms of vulnerability, if an attacker gains the ability to send raw uWSGI protocol data to a server, they may be able to trigger the loading and execution of their Python code. This presents a formidable risk should an exploitation vector like SSRF become accessible.

### SSRF as a Vector for uWSGI Exploitation

Server-Side Request Forgery (SSRF) is an enticement for attackers to interact with internal systems by crafting requests from a vulnerable server to an unauthorized target. When SSRF is leveraged against a uWSGI server, an attacker can send gopher-encoded uWSGI payloads to an exposed uWSGI socket that is usually bound to localhost or internal networks. This vector hinges on the trust assumption that uWSGI sockets on internal interfaces only connect to trusted sources, leading to a potential security oversight.

### Payload Construction and Execution Flow

In the context of SSRF and uWSGI exploitation, payload construction revolves around crafting gopher-encoded data. This data represents the uWSGI protocol messages that specify the `UWSGI_FILE` to execute the malicious script. Notably, gopher encoding permits the transfer of binary protocol data via HTTP-only SSRF restrictions, essentially smuggling the protocol to non-HTTP services.

## Practice

### Remote Command Execution via SSRF and uWSGI_FILE

To conduct remote command execution using SSRF on a uWSGI server, follow these structured steps. This walk-through assumes the attacker has the capability of preparing a Python script on the target server.

- **Prepare a malicious Python script**:
  
  Ensure that a Python script that is intended to execute arbitrary commands, such as `/tmp/test.py`, is present on the target server. This script should be accessible for execution by the uWSGI process.

- **Construct the uWSGI protocol payload**:

  Create a payload to specify `UWSGI_FILE=/tmp/test.py`, instructing uWSGI to execute the malicious script.

- **Gopher-encode the uWSGI payload**:

  Encode the payload using Gopher encoding. This is paramount for bypassing restrictions that limit SSRF capabilities to HTTP only, allowing transmission of binary data.

- **Execute SSRF attack using curl**:

  Utilize the following command to trigger the execution via SSRF:

  ```bash
  curl 'http://vulnerable-app/ssrf?url=gopher://127.0.0.1:9000/_<GOPHER_ENCODED_PAYLOAD>'
  ```

  Replace `<GOPHER_ENCODED_PAYLOAD>` with the actual payload after performing Gopher encoding.

The outcome of this exploitation technique is the execution of arbitrary Python code from the script located at `/tmp/test.py` on the uWSGI server, made possible through the adept use of SSRF and the tailored exploitation of the uWSGI protocol.

## Tools

- **curl**
- **gopherus**
- **python**