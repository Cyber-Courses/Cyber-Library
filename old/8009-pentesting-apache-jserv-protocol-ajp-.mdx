# 8009 - Pentesting Apache JServ Protocol (AJP)


# üëâ¬†Overview

---

### üëÄ¬†What ?

Pentesting Apache JServ Protocol (AJP) is a security assessment technique aimed at detecting and exploiting vulnerabilities in the AJP, a binary protocol designed to handle HTTP request forwarding. AJP is primarily used in Apache Tomcat servers for communication between the server and its connected applications.


### üßê¬†Why ?

AJP is often overlooked in security assessments, despite its critical role in web application architecture. Misconfigurations and vulnerabilities in AJP can lead to significant security incidents, including unauthorized access to sensitive data and potential takeover of the server. Therefore, it is crucial for cybersecurity professionals to understand and routinely conduct pentesting on AJP to ensure the security of their applications.


### ‚õèÔ∏è¬†How ?

To perform pentesting on AJP, you will first need to identify the AJP port (default is 8009) and ensure it is accessible. Then, using a tool like Nmap, you can scan the port for potential vulnerabilities. If vulnerabilities are found, they can be exploited using various methods depending on the specific vulnerability, such as file inclusion exploits or remote code execution. Ensure to follow an ethical hacking approach, only testing systems you have permission to access.


### ‚è≥¬†When ?

Pentesting AJP should be a regular part of your security assessment routine. It became particularly important after the discovery of the Ghostcat vulnerability (CVE-2020-1938) in early 2020, which allows attackers to read or include files from the server through AJP.


# ‚öôÔ∏è¬†Technical Explanations

---

Apache JServ Protocol (AJP) is a binary protocol that facilitates high-speed communication between a front-end web server and a backend application server. It operates by forwarding HTTP requests from the web server to an application server that comprehends the AJP protocol, which offers performance benefits over HTTP due to its binary nature.

Understanding AJP and its operation is critical due to its significant role in web application architecture. Misconfigurations, such as allowing the AJP connector to process requests from untrusted sources, can result in vulnerabilities and potential security incidents. For instance, the Ghostcat vulnerability is an example where an attacker can send a specially crafted AJP request to read or include any file on the server's filesystem that the application server can access. This vulnerability underscores the potential risks associated with AJP.

To conduct penetration testing (pentesting) on AJP, you need to identify the AJP port (default is 8009) and ensure it's accessible. Tools like Nmap can be used to scan the port for potential vulnerabilities. If vulnerabilities are identified, they can be exploited using different methods depending on the specific vulnerability. This could involve file inclusion exploits or remote code execution. It is crucial to follow ethical hacking norms and only test systems for which you have permission.

To mitigate the risks associated with AJP, it is advisable to disable it if not necessary. If it is needed, it should be limited to listen only on localhost and access should be restricted to trusted networks. Regular pentesting should be part of the security assessment routine to detect and address any potential vulnerabilities promptly.

Let's take a look at a detailed, educational example of penetrating testing (pentesting) on AJP, using the tool Nmap.

1. **Identify the AJP port:** The default is 8009, but it can be different depending on the server configuration. You can identify the port by reviewing the server's configuration files or using a port scanning tool.
    
    ```
    nmap -p- --min-rate=5000 --open <target IP
    
    ```
    
    This command scans all 65535 ports (`-p-`) at a fast rate (`--min-rate=5000`) and only shows open ports (`--open`) for the target IP address. You're looking for port 8009 or whichever port AJP is running on.
    
2. **Scan the AJP port:** Once the AJP port is identified, use Nmap to scan for potential vulnerabilities.
    
    ```
    nmap -p 8009 -sV --script ajp-* <target IP
    
    ```
    
    This command scans port 8009 (`-p 8009`), runs service detection (`-sV`), and executes all Nmap scripts with a filename that starts with 'ajp-' (`--script ajp-*`).
    
3. **Interpreting results:** The output from Nmap will provide information about potential vulnerabilities. For example, it might flag that AJP is allowing requests from untrusted sources, which is a misconfiguration that could allow an attacker to read or include any file on the server's filesystem.
4. **Exploitation:** Depending on the vulnerabilities identified, you may be able to exploit them. For example, if a file inclusion vulnerability is found, you might be able to use a tool like Burp Suite to send a specially crafted AJP request to read files from the server.
    
    ```
    GET /path/to/vulnerable/file.jsp HTTP/1.1
    Host: vulnerable-website.com
    
    ```
    
    This is a simple example of what the HTTP request might look like. This should only be done on systems you have permission to test.
    
5. **Mitigation:** If vulnerabilities are found, they should be mitigated as soon as possible. This could involve disabling AJP if it's not necessary, limiting it to listen only on localhost, and restricting access to trusted networks.

Remember, regular pentesting should be part of the security assessment routine to detect and address any potential vulnerabilities promptly.
